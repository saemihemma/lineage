# Pre-commit Hook Configuration

## Smoke Tests Before Commit

This repository uses a **pre-commit hook** that automatically runs smoke tests before every commit.

### What It Does

The pre-commit hook runs:
- `backend/tests/test_smoke.py` - Critical user journey tests (golden path)

These tests validate:
- Complete user journey (session → gather → build → expedition → upload)
- No backend errors (500s, exceptions)
- Timer/progress bar mechanics
- All critical API endpoints
- HMAC signing, CSRF protection

### Installation

The hook is already installed at `.git/hooks/pre-commit`.

To verify it's active:
```bash
ls -la .git/hooks/pre-commit
```

### How It Works

1. You run `git commit`
2. Hook automatically runs smoke tests
3. If tests pass → commit proceeds
4. If tests fail → commit is blocked

### Skipping the Hook (Emergency Only)

**WARNING:** Only skip in true emergencies (hotfixes, etc.)

```bash
git commit --no-verify -m "emergency: skip smoke tests"
```

### Running Tests Manually

```bash
# Run all smoke tests
python3 -m pytest backend/tests/test_smoke.py -v

# Run just the golden path test
python3 -m pytest backend/tests/test_smoke.py::TestGoldenPath::test_complete_golden_path_from_scratch -v
```

### Troubleshooting

**Hook not running?**
- Ensure it's executable: `chmod +x .git/hooks/pre-commit`
- Check git config: `git config core.hooksPath` (should be empty or `.git/hooks`)

**Tests fail but code looks fine?**
- Check recent changes that might have broken the golden path
- Run tests manually to see full error output
- Check database state: `ls -la test_lineage_precommit.db`

**Hook too slow?**
- Tests typically run in < 10 seconds
- If slow, check if pytest is finding the right database
- Consider optimizing test setup/teardown

### Configuration Files

- Hook script: `.git/hooks/pre-commit`
- Smoke tests: `backend/tests/test_smoke.py`
- GitHub Actions: `.github/workflows/tests.yml` (runs on push, not pre-commit)

### Related Documentation

- See `backend/tests/test_smoke.py` for test details
- See `.github/workflows/tests.yml` for CI/CD test configuration

